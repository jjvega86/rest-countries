import Head from "next/head";
import CountryCard from "@/components/CountryCard";
import { getUniqueRegions } from "@/util/helpers";
import { useEffect, useState } from "react";

interface Country {
  name: { common: string };
  capital: string;
  region: string;
  population: number;
  flags: { png: string };
}

export default function Home({ data }: any) {
  const [countries, setCountries] = useState(data);
  const [search, setSearch] = useState("");
  const [currentRegion, setCurrentRegion] = useState("");
  const regions = getUniqueRegions(data);

  useEffect(() => {
    const searchedCountries = data.filter((country: Country) =>
      country.name.common.toLocaleLowerCase().includes(search)
    );
    setCountries(searchedCountries);
  }, [search]);

  useEffect(() => {
    if (currentRegion === "All Regions") {
      setCountries(data);
    } else {
      setCountries(
        data.filter((country: Country) => country.region === currentRegion)
      );
    }
  }, [currentRegion]);

  return (
    <>
      <Head>
        <title>✈️ Traveler&apos;s Hub</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <section className="mx-10">
        <div className="flex justify-between my-6">
          <input
            className="mt-5 border-solid border-2"
            type="text"
            value={search}
            onChange={(e) => setSearch(e.target.value)}
          />
          <p>{search}</p>
          <select onChange={(e) => setCurrentRegion(e.target.value)}>
            {regions.map((region) => (
              <option value={region}>{region}</option>
            ))}
          </select>
        </div>
        <div className="grid place-content-center sm:grid-cols-4 gap-12">
          {countries.map((country: Country) => (
            <CountryCard
              key={country.name.common}
              name={country.name.common}
              capital={country.capital}
              region={country.region}
              population={country.population}
              image={country.flags.png}
            />
          ))}
        </div>
      </section>
    </>
  );
}

export async function getServerSideProps() {
  const res = await fetch("https://restcountries.com/v3.1/all");
  const data = await res.json();

  return { props: { data } };
}
